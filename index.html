window.addEventListener('DOMContentLoaded', async () => {
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDTqQbagHh-HLAdNI56wEsgayUSNcmDJyg",
        authDomain: "webkv-6a265.firebaseapp.com",
        projectId: "webkv-6a265",
        storageBucket: "webkv-6a265.firebasestorage.app",
        messagingSenderId: "261103939337",
        appId: "1:261103939337:web:7981bbce2a277693026dd8",
        measurementId: "G-3QQR2K785N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const startDate = new Date('2025-05-13');
    const daysToGenerate = 60;
    const entries = [];
    const rooms = ['Кімната 1', 'Кімната 2', 'Кімната 3'];

    for (let i = 0; i < daysToGenerate; i += 2) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const roomIndex = (i / 2) % rooms.length;
        const room = rooms[roomIndex];
        const dateStr = `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
        entries.push({ date: dateStr, room: room });
    }

    const tableBody = document.querySelector('tbody');
    for (const entry of entries) {
        const row = document.createElement('tr');
        const checkboxId = `${entry.date}_${entry.room}`;
        row.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.room}</td>
            <td><input type="checkbox" id="${checkboxId}"></td>
        `;
        tableBody.appendChild(row);

        const checkbox = document.getElementById(checkboxId);
        const docRef = doc(db, 'cleaning_schedule', checkboxId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            checkbox.checked = docSnap.data().is_cleaned;
        }
    }

    document.getElementById('cleaningForm').addEventListener('submit', async function (event) {
        event.preventDefault();
        for (const entry of entries) {
            const checkbox = document.getElementById(`${entry.date}_${entry.room}`);
            const isCleaned = checkbox.checked;
            const docRef = doc(db, 'cleaning_schedule', `${entry.date}_${entry.room}`);
            try {
                await setDoc(docRef, { is_cleaned: isCleaned });
            } catch (error) {
                console.error("Error saving document: ", error);
            }
        }
        showSuccessMessage();
    });

    function showSuccessMessage() {
        const successMessage = document.getElementById('successMessage');
        successMessage.style.visibility = 'visible';
        successMessage.style.opacity = '1';

        setTimeout(() => {
            successMessage.style.opacity = '0';
            successMessage.style.visibility = 'hidden';
        }, 3000);
    }
});
